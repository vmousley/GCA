---
title: "Data Import NANS"
author: "Teresa Del Bianco"
date: "`r Sys.Date()`"
output: html_document
---

This script is importing the raw data comprising NAs (at the sample level). We extract the proportion of valid trials per task and save it into the object pNA. 

# Load packages 

```{r, messtp = FALSE, warning = FALSE, include = FALSE}
packs <- c("R.matlab", "reshape2", "dplyr", "multidplyr", "ggplot2", "tidyr")
lapply(packs, require, character.only = TRUE)
```

# Read data from matlab (? Hz)

```{r}
cbfnp_matlabFile  <- readMat('MatFiles/LEAP_ET_popout_temporalScores_20200317T221852.mat')
# str(cbfnp_matlabFile)
```

# Trial 1

```{r}
datList <- cbfnp_matlabFile$temporal[[9]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_1 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))

nrow(data_miss_abs_1)-nrow(data_missing_long)
```

## Add trial

```{r}
data_miss_abs_1$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[17]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```

# Trial 2

```{r}
datList <- cbfnp_matlabFile$temporal[[10]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_2 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_2$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[18]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```

# Trial 3

```{r}
datList <- cbfnp_matlabFile$temporal[[11]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_3 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_3$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[19]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```


# Trial 4

```{r}
datList <- cbfnp_matlabFile$temporal[[12]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_4 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_4$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[20]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```

# Trial 5

```{r}
datList <- cbfnp_matlabFile$temporal[[13]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_5 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_5$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[21]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```

# Trial 6

```{r}
datList <- cbfnp_matlabFile$temporal[[14]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_6 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_6$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[22]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```


# Trial 7

```{r}
datList <- cbfnp_matlabFile$temporal[[15]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_7 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_7$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[23]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```


# Trial 8

```{r}
datList <- cbfnp_matlabFile$temporal[[16]][[1]][,,1]
# summary(datList)
```
```{r}
datList.un <- lapply(datList, unlist, use.names=FALSE)
ids <- datList.un$ids
time <- datList.un$time
# summary(datList.un)
# str(datList.un)
```
```{r}
data_missing <- as.data.frame(datList.un$missing)
data_absent <- as.data.frame(datList.un$absent)
```
```{r}
names(data_missing) <- ids
names(data_absent) <- ids
```
```{r}
data_missing$time <- time
data_absent$time <- time
```

## Format data

### Missing

```{r}
# names(data)
data_missing_long <- melt(data_missing,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="missing"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_missing_long$id), "_", c("id", "tp"))
data_missing_long <- cbind(id_tp, dplyr::select(data_missing_long, -id))
```

### Absent

```{r}
# names(data)
data_absent_long <- melt(data_absent,
        # ID variables - all the variables to keep but not split apart on
        id.vars=c("time"),
        # The source columns
        # measure.vars=c("control", "cond1", "cond2" ),
        # Name of the destination column that will identify the original
        # column that the measurement came from
        variable.name="id",
        value.name="absent"
        )
# str(data_c_long)
```
```{r}
id_tp <- colsplit(as.character(data_absent_long$id), "_", c("id", "tp"))
data_absent_long <- cbind(id_tp, dplyr::select(data_absent_long, -id))
```

## Merge Missing and Absent

```{r}
nrow(data_missing_long)-nrow(data_absent_long)
data_miss_abs_8 <- inner_join(data_missing_long, data_absent_long, by=c("id", "tp", "time"))
```

## Add trial

```{r}
data_miss_abs_8$stim <- gsub(x=cbfnp_matlabFile$temporalScores[[24]][[1]][,1], 
                            pattern = ".TIFPOPOUT", 
                            replacement = ".TIF")
```

## Merge all trials together

```{r}
data_miss_abs <- rbind(data_miss_abs_1,
                       data_miss_abs_2,
                       data_miss_abs_3,
                       data_miss_abs_4,
                       data_miss_abs_5,
                       data_miss_abs_6,
                       data_miss_abs_7,
                       data_miss_abs_8)
```

```{r}
data_miss_abs <- data_miss_abs %>%
  separate(col = stim, into = c("cond", "trial"), sep = "_", remove = FALSE) %>%
  mutate(trial=gsub(pattern = "ONSETPOPOUT", replacement = "", x = trial),
         trial=gsub(pattern = ".TIF", replacement = "", x = trial),
         trial=as.double(trial))
```

# Look at the missing data

```{r}
data_miss_abs %>%
  filter(absent==1 & missing==1) #ok
```

```{r}
not_pres <- data_miss_abs %>%
  filter(absent==1) %>%
  distinct(id, tp, time, stim, cond, trial, absent)
head(not_pres)
```

```{r}
load("SavedWS/demo-leap.RData")
```

```{r}
p_NA <- data_miss_abs %>%
  group_by(id, tp, stim, cond, trial) %>%
  summarise(pNA=sum(missing==1)/n()*100) %>%
  inner_join(demo_t1_ft[,c("id", "diagnosis", "site", "ageyrs")], by="id")
head(p_NA)
```

```{r}
tot_t <- p_NA %>%
  group_by(id, tp) %>%
  summarise(N_t=length(stim))

to_excl <- p_NA %>%
  filter(pNA>=75) %>%
  distinct(id, diagnosis, tp, stim, cond, trial, pNA) 

to_excl %>% group_by(diagnosis) %>% summarise(N=n())
```

```{r}
save(p_NA, to_excl, not_pres, file="SavedWS/NA_info.RData")
save(data_miss_abs, file="SavedWS/data_miss_abs.RData")
```